---
title: "Technical Report"
author: "Jordan Majoros, Alli McCarty, Joe Spatz"
date: "2/15/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Install Libraries
library(readxl)
library(tidyverse)
library(dplyr)
library(pastecs)
library(data.table)
library(formattable)
library(tidyr)
library(kableExtra)
library(gridExtra)
library(ggpubr)
library(ggthemes)
library(mgcv)
```


## Abstract:

This part will include **BRIEF**  information from the initial introduction in the SAP as well as details on EDA and/or models included

## Introduction:

Can pull information from SAP intro -- address specific aims and commentary on what types of models we aim to build, contingent on EDA

## Data:

Three additional variables were calculated using the given data and added to the dataset to give more depth to BMI. The participants of the call center study provided their height, number of pounds gained during the eight month period, and body weight at the end as well. With those values, the ending BMI was calculated. To make the ending BMI more valuable we used the provided data to calculate the BMI for each participant before starting the 8 month study. First, the beginning body weight was found using the pounds gained and the weight of the participant at the end. Then the starting BMI was calculated using the formula below with weight measured in pounds and the height the participant presented in inches.

				BMI = 703 * weight (lbs) / [height (inches)]^2
				
Change in BMI was then calculated subtracting the starting BMI from the ending BMI. Many participants did not gain weight so their change in BMI was zero. Percentage BMI change over the 8 month period could have also been calculated by dividing the BMI difference and beginning BMI but that was not included as an additional variable. Analyzing the change in BMI can have advantages over strictly pounds gain if a participant increased their height or started at a below average weight given they are taller than average.  

```{r InitialDataCleaning, include=FALSE}
#Import Data
dat1 <- read_excel("Practicum 1 Data.xlsx")

#From the SAP, we decided that we would include 13 variables in the analysis for this project
#Select variables of interest
myvars <- c("shift", "gender", "Age", "height", "weightgain", "lbs_gained", "pounds_gained", "bweight", "BMI", "VigTime", "WalkTime", "ModTime", "Total_Met_Min")
pracdat <- dat1[myvars]

#Get rid of observations that do not have ANY variables populated
all.na <- (apply(pracdat, 1, function(x){all(is.na(x))}))
pracdat <- data.frame(pracdat, all.na)
pracdat <- subset(pracdat, all.na == "FALSE")

#Get rid of the last column that we used to subset complete cases
pracdat <- pracdat[1:13]

# Next, we will go back and manually calculate metabolic minutes and overwrite the column in the original data frame
# Calculation for Total Met Minutes = 8*VigTime + 4*ModTime + 3.3*WalkTime
pracdat$Total_Met_Min = 8*pracdat$VigTime + 4*pracdat$ModTime + 3.3*pracdat$WalkTime

#Next, we will go back and manually calculate BMI and overwite the column in the original data frame

pracdat$Begin_bweight = ifelse(is.na(pracdat$lbs_gained), pracdat$bweight, (pracdat$bweight)-(pracdat$lbs_gained))
pracdat$Before_BMI = round((703*pracdat$Begin_bweight)/(pracdat$height*pracdat$height),2)
pracdat$BMI_change = (pracdat$BMI)-(pracdat$Before_BMI)

#Now, let's see what variables are missing for each of the predictors
sum(apply(pracdat, 1, function(x){any(is.na(x))})) # Now we have 189 complete cases (61 more than before)

sum(complete.cases(pracdat[1])) #348 out of 352 observations have data on shift
sum(complete.cases(pracdat[5])) #348 out of 352 observations have data on binary weight gain
sum(complete.cases(pracdat[13])) #351 of the 352 observations have metabolic minutes data (meaning they also have data on walk, vig, and mod ex time)
sum(complete.cases(pracdat[6])) #232 of the 352 observations have data for lbs gained
```

## Exploratory Data Analysis:

Visuals for Categorical Variables

```{r, fig.height=4, fig.width=6}
#Gender Total Metabolic by Age
ggplot(na.omit(pracdat), aes(x = Age, y = Total_Met_Min, color = gender)) + geom_line(size = .8) + facet_grid(. ~ gender) + theme_bw() + theme(panel.grid = element_blank()) + ggtitle("Total Metabolic Minutes by Age and Gender")

#Change in BMI for Each Time Shift
ggplot(na.omit(pracdat), aes(x= gender, y =BMI_change)) + geom_boxplot(aes(color = gender)) + facet_grid(. ~ shift) + theme(axis.text.x = element_text(angle=90, hjust=1)) + ggtitle("Change in BMI for Each Time Shift")

#
p1 <- ggplot(na.omit(pracdat), aes(x = shift, y = VigTime, fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, hjust=1))
p2 <- ggplot(na.omit(pracdat), aes(x = shift, y = WalkTime, fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, hjust=1))
p3 <- ggplot(na.omit(pracdat), aes(x = shift, y = ModTime, fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, hjust=1))
p4 <- ggplot(na.omit(pracdat), aes(x = shift, y = Total_Met_Min, fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, hjust=1))
grid.arrange(p1, p2, p3, p4, nrow = 2)

```


In order to test the assumption of normalcy for the variables, we made QQPlots for all of the continuous numeric variables (Appendix 1).  Based on the plots, we think that age, height, body weight, and BMI are approximately normal (at least normal enough that they do not merit transformations).

Pounds gained, VigTime, ModTime, and WalkTime, and TotalMetMinutes do not follow a normal distribution and have a strong right skew. We will take a closer look at these variables and try a log transformation if necessary.

```{r}
library(car)
pracdat.cont <- pracdat[c(-1:-2, -5:-6)]
cont.labels <- colnames(pracdat.cont)
pracdat.abnormal <- pracdat.cont[c(3, 6:9)]
library(reshape2)
pracdat.abnormal<- melt(pracdat.abnormal)
ggplot(data = pracdat.abnormal , aes(x = value)) + stat_density() + facet_wrap(~variable, scales = "free")
#Most have an extreme right skew

#Now, let's take a log transformation of all of these variables
ggplot(data = pracdat.abnormal , aes(x = log(value))) + stat_density() + facet_wrap(~variable, scales = "free")
# Much better


#Perform the transformation to overall dataframe
pracdat$lbs_gained <- log(pracdat$lbs_gained)
pracdat$pounds_gained <- log(pracdat$pounds_gained)
pracdat$VigTime <- log(pracdat$VigTime)
pracdat$WalkTime <- log(pracdat$WalkTime)
pracdat$ModTime <- log(pracdat$ModTime)
pracdat$Total_Met_Min <- log(pracdat$Total_Met_Min)
```



## Model Process:
Commentary on lack of data for lbs gained and motivation for building two separate models: 

There are a lot of N/A values for lbs gained because we will not have data for a specific observation unless they gained weight. If a person lost weight in the study, this would be populated as "N/A" for lbs gained (col 6). For the purposes of the second model, we may choose to select the subset of the population who gained weight (have data for this variable)/or did not gain weight (do NOT have data for this variable) and create a model specific to that subset.


For Model 1, we will just use the binary weight gain variable to create a logistic model.  For Model 2, we will subset the sample to those who gained weight, and build multiple models to determine which factors influenced this weight gain.

Data Cleaning specific to our models:
```{r MoreDataCleaning}
#Create final data frame for Model #1
pracdat.mod1 <- pracdat[-6:-7]
#Change Weight Gain Factor Variable to Binary
pracdat.mod1$weightgain <- ifelse(pracdat.mod1$weightgain=="Yes",1,0)


# Create subset data frames for Model #2
pracdat.mod2 <- subset(pracdat, weightgain == "Yes")
```

Binary WeightGain Model **should use pracdat.mod1**

```{r}
#weightglm1 = glm(weightgain ~ VigTime + WalkTime + ModTime, data = pracdat, family = "binomial)
#weightglm2 = glm(weightgain ~  , family = "binomial)
#weightglm3 = glm(weightgain ~  , family = "binomial)
#weightglm4 = glm(weightgain ~  , family = "binomial)

#cv.weight1 = mean(residuals(weightglm1)^2/(1-hatvalues(weightglm1))^2)
#cv.weight1 = mean(residuals(weightglm1)^2/(1-hatvalues(weightglm1))^2)
#cv.weight1 = mean(residuals(weightglm1)^2/(1-hatvalues(weightglm1))^2)
#cv.weight1 = mean(residuals(weightglm1)^2/(1-hatvalues(weightglm1))^2)

#data.frame(cv.weightg1,cv.weightg2,cv.weightg3,cv.weightg4)

#favorite.table <- summary(final_model)$coefficients
#kable(favorite.table, digits=5)
```

**If our specific aims are testing whether shift and total metabolic minutes have an effect on weight gain, shouldn't the be in all the models**

Multivariate Linear Model - only GAINED
```{r}
#length(pracdat.mod2$lbs_gained)
#length(pracdat.mod2$shift)
multi.mod1 = glm(lbs_gained ~ shift, data = pracdat.mod2)

cv.weight1 = mean(residuals(multi.mod1)^2/(1-hatvalues(multi.mod1))^2)

data.frame(cv.weight1)
```

## Discussion and Conclusion


## Appendix

Test for normality of the continuous variables:

```{r}
#First, we want to make qqnorm plots for all of the continuous variables, which will be used to justify transformations and included in the appendix

newfun <- function(x, y) qqPlot(x, main = paste(y, "QQ Plot", sep = " "))
par(mfrow = c(1, 2))
mapply(newfun, pracdat.cont, cont.labels)
```