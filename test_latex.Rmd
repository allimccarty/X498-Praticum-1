---
title: "Technical Report"
author: "Jordan Majoros, Alli McCarty, Joe Spatz"
date: "2/15/2021"
output: pdf_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#Install Libraries
library(readxl)
library(tidyverse)
library(dplyr)
library(pastecs)
library(data.table)
library(formattable)
library(tidyr)
library(kableExtra)
library(gridExtra)
library(ggpubr)
library(ggthemes)
library(mgcv)
```


## Abstract:

The purpose of this analysis is to use modern statistical applications to determine what variables, with a particular emphasis on minutes of metabolic exercise and time of work shift, influence weight gain in Americans.  The data comes from a self-report questionnaire administered by a call center over an eight month period.  The data was processed and exploratory data analysis was performed to gain insight into basic trends and collinearity between variables.  Several transformations were performed on variables with skewed distributions, and the most important variables were selected via nonparametric analysis to be included in our models.  Two models were constructed; a logistic regression model to obtain binary predictions on weight gain, and a generalized additive model using various predictors to estimate weight gain in pounds. The model fits were cross validated via ***WHAT??* and residual analysis was performed.

## Introduction:

Diseases such as obesity, diabetes, coronary heart disease, and musculoskeletal disorders have rapidly increased in the United States in the last decade, which can be partially attributed to the change in office culture to be heavily computer-based and therefore more sedentary. Increased prevalence of such diseases are expensive to organizations and influence how productive and efficient workers can be. Lifestyle habits of employees affect rates of obesity and obesity-related diseases in the United States. The purpose of our analysis was to answer what is affecting the weight change of employees in a call center. Descriptive statistics and graphs were used to visualize relationships between different categorical and continuous variables. We confirmed normality for these variables and used log plus one transformation for right skewed distributions. Work shift and total metabolic minutes were two variables at the center of our analysis. We showed their effect on weight gain through exploratory data analysis. Two models have been built to show the statistical significance of certain predictors. The first model used logistic regression with weight gain (yes/no) being the categorical response variable. Our second model was a multivariate linear model that focuses on the significance of shift start time and total metabolic minutes. The following report records our central ideas and provides evidence for the procedures taken. 

## Data:

Three additional variables were calculated using the given data and added to the dataset to give more depth to BMI. The participants of the call center study provided their height, number of pounds gained during the eight month period, and body weight at the end as well. With those values, the ending BMI was calculated. To make the ending BMI more valuable we used the provided data to calculate the BMI for each participant before starting the 8 month study. First, the beginning body weight was found using the pounds gained and the weight of the participant at the end. Then the starting BMI was calculated using the formula below with weight measured in pounds and the height the participant presented in inches.

				BMI = 703 * weight (lbs) / [height (inches)]^2
				
Change in BMI was then calculated subtracting the starting BMI from the ending BMI. Many participants did not gain weight so their change in BMI was zero. Percentage BMI change over the 8 month period could have also been calculated by dividing the BMI difference and beginning BMI but that was not included as an additional variable. Analyzing the change in BMI can have advantages over strictly pounds gain if a participant increased their height or started at a below average weight given they are taller than average.  

```{r InitialDataCleaning, include=FALSE}
#Import Data
dat1 <- read_excel("Practicum 1 Data.xlsx")

#From the SAP, we decided that we would include 13 variables in the analysis for this project
#Select variables of interest
myvars <- c("shift", "gender", "Age", "height", "weightgain", "lbs_gained", "pounds_gained", "bweight", "BMI", "VigTime", "WalkTime", "ModTime", "Total_Met_Min")
pracdat <- dat1[myvars]

#Get rid of observations that do not have ANY variables populated
all.na <- (apply(pracdat, 1, function(x){all(is.na(x))}))
pracdat <- data.frame(pracdat, all.na)
pracdat <- subset(pracdat, all.na == "FALSE")

#Get rid of the last column that we used to subset complete cases
pracdat <- pracdat[1:13]

# Next, we will go back and manually calculate metabolic minutes and overwrite the column in the original data frame
# Calculation for Total Met Minutes = 8*VigTime + 4*ModTime + 3.3*WalkTime
pracdat$Total_Met_Min = 8*pracdat$VigTime + 4*pracdat$ModTime + 3.3*pracdat$WalkTime

#Next, we will go back and manually calculate BMI and overwrite the column in the original data frame

pracdat$Begin_bweight = ifelse(is.na(pracdat$lbs_gained), pracdat$bweight, (pracdat$bweight)-(pracdat$lbs_gained))
pracdat$Before_BMI = round((703*pracdat$Begin_bweight)/(pracdat$height*pracdat$height),2)
pracdat$BMI_change = (pracdat$BMI)-(pracdat$Before_BMI)

#Now, let's see what variables are missing for each of the predictors
sum(apply(pracdat, 1, function(x){any(is.na(x))})) # Now we have 189 complete cases (61 more than before)

sum(complete.cases(pracdat[1])) #348 out of 352 observations have data on shift
sum(complete.cases(pracdat[5])) #348 out of 352 observations have data on binary weight gain
sum(complete.cases(pracdat[13])) #351 of the 352 observations have metabolic minutes data (meaning they also have data on walk, vig, and mod ex time)
sum(complete.cases(pracdat[6])) #232 of the 352 observations have data for lbs gained
```

## Exploratory Data Analysis:

### Visuals for Categorical Variables

Our first graph shows the distribution of total metabolic minutes by increasing age for both genders of employees in the call center study. Female employees see most of their peak total metabolic minutes from the age group 20 to 30. After around age 32 it begins to average out and see a smaller range of values. From age 45 onward the total metabolic minutes stays under 2400 minutes. The male employees have their total metabolic minutes peak just under 7500 minutes. The rest of the male call center employees had total metabolic minutes under about 3500 minutes. Male and female employees do not show similar total metabolic minutes distributions for ages 20 to 60.   

```{r, fig.height=4, fig.width=6, echo = FALSE}
#Gender Total Metabolic by Age
ggplot(na.omit(pracdat), aes(x = Age, y = Total_Met_Min, color = gender)) + geom_line(size = .8) + facet_grid(. ~ gender) + theme_bw() + theme(panel.grid = element_blank()) + ggtitle("Total Metabolic Minutes by Age for Each Gender")
```

The change in BMI over the 8 month study period for the different shift start times is displayed in a boxplot with male and female separated. We see smaller spread of BMI change values for work shifts starting between 11am and 2pm with only one female observation at the 2pm shift being a large outlier. The 8am start time shift is the only time that has a more spread distribution of BMI change for male over female employees. There are less male employees so the mean BMI change for each shift can be pulled higher more easily by the outlier observations. Overall we see larger BMI changes from the morning shifts of both genders. 

```{r}
#Change in BMI for Each Time Shift
ggplot(na.omit(pracdat),aes(x=gender,y=BMI_change)) + geom_boxplot(aes(color=gender)) + facet_grid(. ~ shift)+ theme(axis.text.x = element_text(angle=90,vjust=.5,hjust=1)) + ggtitle("Change in BMI for Each Time Shift")
```
The next four visuals show average exercise time in minutes by gender for different intensity exercises. The three intensity measures are vigorous, moderate, and walking. Vigorous being the high-intensity exercise. The fourth barplot uses the three intensities to calculate total metabolic minutes. Each graph examines the average times for each starting shift time.  

```{r}
#Average Times by Gender for Each Shift
p1 <- ggplot(na.omit(pracdat), aes(x = shift, y = mean(VigTime), fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1)) + xlab("Shift Time") + ylab("Average Vig Time") + scale_x_discrete(limits=c('7am', '8am', '9am', '10am', '11am', '12pm', '1pm', '2pm', "other")) + ggtitle("Average Vigorous Time by Shift")

p2 <- ggplot(na.omit(pracdat), aes(x = shift, y = mean(WalkTime), fill=gender)) + geom_bar(stat="identity") + theme_minimal() +theme(axis.text.x = element_text(angle=90, vjust=.5,hjust=1))+ xlab("Shift Time") + ylab("Average Walk Time") + scale_x_discrete(limits=c('7am', '8am', '9am', '10am', '11am', '12pm', '1pm', '2pm', "other")) + ggtitle("Average Walk Time by Shift")

p3 <- ggplot(na.omit(pracdat), aes(x = shift, y = mean(ModTime), fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))+ xlab("Shift Time") + ylab("Average Mod Time") + scale_x_discrete(limits=c('7am', '8am', '9am', '10am', '11am', '12pm', '1pm', '2pm', "other")) + ggtitle("Average Moderate time by Shift")

p4 <- ggplot(na.omit(pracdat), aes(x = shift, y = mean(Total_Met_Min), fill=gender)) + geom_bar(stat="identity") + theme_minimal() + theme(axis.text.x = element_text(angle=90, vjust=.5,hjust=1))+ xlab("Shift Time") + ylab("Average Total Metabolic Minutes") + scale_x_discrete(limits=c('7am', '8am', '9am', '10am', '11am', '12pm', '1pm', '2pm', "other")) + ggtitle("Average Total Metabolic by Shift")

grid.arrange(p1, p2, p3, p4, nrow = 2)
```

In order to test the assumption of normalcy for the variables, we made QQPlots for all of the continuous numeric variables (Appendix 1).  Based on the plots, we think that age, height, body weight, and BMI are approximately normal (at least normal enough that they do not merit transformations).

Pounds gained, VigTime, ModTime, and WalkTime, and TotalMetMinutes do not follow a normal distribution and have a strong right skew. We will take a closer look at these variables and try a log transformation if necessary.

```{r, echo = FALSE}
library(car)
pracdat.cont <- pracdat[c(-1:-2, -5:-6)]
cont.labels <- colnames(pracdat.cont)
pracdat.abnormal <- pracdat.cont[c(3, 6:9)]
library(reshape2)
pracdat.abnormal<- melt(pracdat.abnormal)
ggplot(data = pracdat.abnormal , aes(x = value)) + stat_density() + facet_wrap(~variable, scales = "free")
#Most have an extreme right skew

#Now, let's take a log transformation of all of these variables
ggplot(data = pracdat.abnormal , aes(x = log(value))) + stat_density() + facet_wrap(~variable, scales = "free")
# Much better


#Perform the transformation to overall dataframe
pracdat$lbs_gained <- log(pracdat$lbs_gained+1)
pracdat$pounds_gained <- log(pracdat$pounds_gained+1)
pracdat$VigTime <- log(pracdat$VigTime+1)
pracdat$WalkTime <- log(pracdat$WalkTime+1)
pracdat$ModTime <- log(pracdat$ModTime+1)
pracdat$Total_Met_Min <- log(pracdat$Total_Met_Min+1)
```

Now, let's test for collinearity between variables:

```{r, echo = FALSE}
pairs(pracdat[c(3, 7:13)])
```

The first obvious thing to note is that BMI and body weight are positively correlated.  This should be expected, because we caluclated BMI via a linear combination including body weight.

## Model Process:
Commentary on lack of data for lbs gained and motivation for building two separate models: 

There are a lot of N/A values for lbs gained because we will not have data for a specific observation unless they gained weight. If a person lost weight in the study, this would be populated as "N/A" for lbs gained (col 6). For the purposes of the second model, we may choose to select the subset of the population who gained weight (have data for this variable)/or did not gain weight (do NOT have data for this variable) and create a model specific to that subset.


For Model 1, we will just use the binary weight gain variable to create a logistic model.  For Model 2, we will subset the sample to those who gained weight, and build multiple models to determine which factors influenced this weight gain.

Data Cleaning specific to our models:
```{r MoreDataCleaning}
#Create New Grouping Model Based on Shift Time
shift2 <- pracdat$shift
#Apologies, there was probably a more elegant way to do this
shift.recode<- character(length(shift2))
shift.recode[shift2 == "7am"] <- "morning"
shift.recode[shift2 == "8am"] <- "morning"
shift.recode[shift2 == "9am"] <- "morning"
shift.recode[shift2 == "10am"]<- "morning"
shift.recode[shift2 == "11am"]<- "afternoon"
shift.recode[shift2 == "12pm"]<- "afternoon"
shift.recode[shift2 == "1pm"] <- "afternoon"
shift.recode[shift2 == "2pm"] <- "afternoon"
shift.recode[shift2 == "3pm"] <- "other"
shift.recode[shift2 == "other"] <- "other"
shift.recode[is.na(shift2)] <- NA
pracdat$shift.recode <- shift.recode

#Create final data frame for Model #1
pracdat.mod1 <- pracdat[-6:-7]
#Change Weight Gain Factor Variable to Binary
pracdat.mod1$weightgain <- ifelse(pracdat.mod1$weightgain=="Yes",1,0)


# Create subset data frames for Model #2
pracdat.mod2 <- subset(pracdat, weightgain == "Yes")
```

We created a logistic regression model for our binary dependent variable 'weightgain', yes or no. The model with the best fit contained three predictor variables: Total_Met_Min, gender, and Age. The response will be close to 1 when the person has gained weight and 0 when they have not gained weight over the 8 month period.  


glm(weightgain ~ Total_Met_Min + gender + Age, data = pracdat.mod1, family = "binomial")

```{r}
#weightglm1 = glm(weightgain ~ VigTime + WalkTime + ModTime + gender + Age, data = pracdat.mod1, family = "binomial")
weightglm2 = glm(weightgain ~ Total_Met_Min + gender + Age, data = pracdat.mod1, family = "binomial")
#weightglm3 = glm(weightgain ~ shift + gender + Age, data = pracdat.mod1, family = "binomial")
#weightglm4 = glm(weightgain ~ shift + gender, data = pracdat.mod1, family = "binomial")

#cv.weight1 = mean(residuals(weightglm1)^2/(1-hatvalues(weightglm1))^2)
cv.weight2 = mean(residuals(weightglm2)^2/(1-hatvalues(weightglm2))^2)
#cv.weight3 = mean(residuals(weightglm3)^2/(1-hatvalues(weightglm3))^2)
#cv.weight4 = mean(residuals(weightglm4)^2/(1-hatvalues(weightglm4))^2)

#data.frame(cv.weight1,cv.weight2,cv.weight3,cv.weight4)

favorite.table <- summary(weightglm2)$coefficients
kable(favorite.table, digits=5)
par(mfrow = c(2, 2))
plot(weightglm2)
```

**If our specific aims are testing whether shift and total metabolic minutes have an effect on weight gain, shouldn't the be in all the models**

Multivariate Linear Model - only GAINED
```{r}
#length(pracdat.mod2$lbs_gained)
#length(pracdat.mod2$shift)
multi.mod1 = glm(lbs_gained ~ shift + Total_Met_Min, data = pracdat.mod2)
multi.mod2 = glm(lbs_gained ~ shift + Total_Met_Min + Age, data = pracdat.mod2)
multi.mod3 = glm(lbs_gained ~ shift + Total_Met_Min + Age  + gender, data = pracdat.mod2)


#summary(multi.mod1)

cv.weight1 = mean(residuals(multi.mod1)^2/(1-hatvalues(multi.mod1))^2)
cv.weight3 = mean(residuals(multi.mod2)^2/(1-hatvalues(multi.mod2))^2)
cv.weight4 = mean(residuals(multi.mod3)^2/(1-hatvalues(multi.mod3))^2)


data.frame(c(cv.weight1, cv.weight3, cv.weight4))
newtable <- summary(multi.mod3)$coefficients
kable(newtable, digits=5)

par(mfrow = c(2, 2))
plot(multi.mod3)
```

Based on preliminary data analysis, we found shift is not a significant predictor. We found that 7-8 am are significant, which is an interesting perspective on morning versus afternoon shifts. 

## Discussion and Conclusion



## Appendix 

Test for normality of the continuous variables:

```{r}
#First, we want to make qqnorm plots for all of the continuous variables, which will be used to justify transformations and included in the appendix
newfun <- function(x, y) qqPlot(x, main = paste(y, "QQ Plot", sep = " "))
par(mfrow = c(2, 3))
mapply(newfun, pracdat.cont, cont.labels)
mtext("Appendix 1", side=1, outer=TRUE, adj=0)
```